<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist de H√°bitos</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Checklist">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5610/5610944.png">
<link rel="manifest" href="manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("Service Worker Registrado!"));
  }
</script>

<style>
  :root {
    /* Cores do Tema Claro */
    --bg: #f8fafc;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --item-bg: #f1f5f9;
    --item-hover: #e2e8f0;
    --border: #e2e8f0;
    --success: #22c55e;
    --danger: #ef4444;
  }

  /* Vari√°veis do Tema Escuro */
  body.dark-mode {
    --bg: #0f172a;
    --card-bg: #1e293b;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --primary: #818cf8;
    --primary-dark: #6366f1;
    --item-bg: #334155;
    --item-hover: #475569;
    --border: #334155;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background-color: var(--bg);
    color: var(--text-main);
    margin: 0;
    padding: 16px;
    display: flex;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 480px;
    padding-bottom: 40px;
  }

  /* Header com Toggle de Tema */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  h1 { font-size: 1.5rem; margin: 0; color: var(--primary); }

  .theme-toggle {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 1.2rem;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }

  .card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
  }

  /* Se√ß√£o de Data */
  .date-header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .date-controls { display: flex; gap: 8px; }

  input[type="date"], input[type="text"], select {
    flex-grow: 1;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-size: 16px;
    outline: none;
    background: var(--item-bg);
    color: var(--text-main);
  }

  .btn-today {
    padding: 0 15px;
    border-radius: 12px;
    border: none;
    background: var(--primary);
    color: white;
    font-weight: 600;
  }

  .active-date-info {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-align: center;
    font-weight: 500;
  }

  /* Lista de Itens */
  .section-title {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 20px 0 10px 4px;
    font-weight: 700;
  }

  .habit-item {
    display: flex;
    align-items: center;
    background: var(--item-bg);
    margin-bottom: 8px;
    padding: 14px 16px;
    border-radius: 14px;
    cursor: pointer;
    border: 2px solid transparent;
  }

  .habit-item.checked {
    background: rgba(34, 197, 94, 0.15);
    border-color: var(--success);
  }

  .habit-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    accent-color: var(--success);
  }

  .habit-text { flex-grow: 1; font-size: 15px; font-weight: 500; }
  .checked .habit-text { text-decoration: line-through; color: var(--text-muted); }

  .btn-delete {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: none;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: bold;
  }

  /* Pontua√ß√£o */
  .points-badge {
    text-align: center;
    background: var(--primary);
    color: white;
    padding: 14px;
    border-radius: 16px;
    font-weight: 800;
    margin-top: 15px;
    font-size: 1.1rem;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .add-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
  }

  .cycle-summary {
    background: var(--item-bg);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    margin-top: 15px;
  }

  #cycleSelect {
    width: 100%;
  }

  .day-log { list-style: none; padding: 0; margin: 0; }
  .day-log li {
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    font-size: 14px;
  }
</style>
</head>

<body>
<div class="container">

<header>
  <h1>‚úÖ Checklist</h1>
  <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">üåì</button>
</header>

<div class="card">
  <div class="date-header">
    <div class="date-controls">
      <input type="date" id="datePicker">
      <button class="btn-today" onclick="setToday()">Hoje</button>
    </div>
    <div class="active-date-info" id="activeDateText"></div>
  </div>

  <div class="section-title">H√°bitos Di√°rios</div>
  <div id="checklist"></div>
  
  <div class="section-title">Metas Extras</div>
  <div id="extraGoalsList"></div>
  
  <div class="points-badge" id="dailyPoints">0 Pontos Acumulados</div>
</div>

<div class="card">
  <div class="section-title" style="margin-top:0">Criar Nova Meta</div>
  <input type="text" id="newGoalInput" placeholder="Ex: Estudar Ingl√™s..." style="width:100%">
  <button class="add-btn" onclick="addNewGoal()">Adicionar Meta</button>
</div>

<div class="card">
  <div class="section-title" style="margin-top:0">üìä Relat√≥rio do Ciclo</div>
  <select id="cycleSelect"></select>
  <div class="cycle-summary">
    <div id="cycleRange" style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;"></div>
    <strong>Total do Ciclo: <span id="cyclePoints">0</span> pts</strong>
  </div>
  <ul class="day-log" id="cycleDays"></ul>
</div>

</div>

<script>
const ITEMS = ["Alimenta√ß√£o saud√°vel", "Comer salada", "Comer fruta", "Sem doces", "Sem fast food", "Beber 2L de √°gua", "Dormir 7h+"];
const STORAGE = "habitData";
const GOALS_STORAGE = "habitCustomGoals";
const THEME_STORAGE = "habitTheme";

const data = JSON.parse(localStorage.getItem(STORAGE) || "{}");
let customGoals = JSON.parse(localStorage.getItem(GOALS_STORAGE) || "[]");

// --- L√≥gica de Tema ---
function toggleTheme() {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem(THEME_STORAGE, isDark ? 'dark' : 'light');
  document.getElementById("themeToggle").innerText = isDark ? "‚òÄÔ∏è" : "üåô";
}

// Carregar tema salvo ou prefer√™ncia do sistema
if (localStorage.getItem(THEME_STORAGE) === 'dark' || 
    (!localStorage.getItem(THEME_STORAGE) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
  document.body.classList.add('dark-mode');
  document.getElementById("themeToggle").innerText = "‚òÄÔ∏è";
}

// --- Fun√ß√µes do Checklist ---
const datePicker = document.getElementById("datePicker");

function formatKey(date) { return date.toISOString().split('T')[0]; }


function parseDate(key) { 
  const parts = key.split("-").map(Number);
  return new Date(parts[0], parts[1] - 1, parts[2]);
}

function setToday() {
  const now = new Date();
  const offset = now.getTimezoneOffset();
  const dateNow = new Date(now.getTime() - (offset * 60 * 1000));
  datePicker.value = dateNow.toISOString().split('T')[0];
  loadChecklist(datePicker.value);
}

function save() {
  try {
    localStorage.setItem(STORAGE, JSON.stringify(data));
    localStorage.setItem(GOALS_STORAGE, JSON.stringify(customGoals));
    updateCycleReport();
  } catch (e) {
    console.error("Erro ao salvar no localStorage:", e);
    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
      alert("Espa√ßo de armazenamento cheio ou voc√™ est√° em Navega√ß√£o Privada!");
    }
  }
}

function addNewGoal() {
  const input = document.getElementById("newGoalInput");
  const val = input.value.trim();
  if (val && !customGoals.includes(val)) {
    customGoals.push(val);
    input.value = "";
    save();
    loadChecklist(datePicker.value);
  }
}

function deleteGoal(e, goal) {
  e.stopPropagation();
  if(confirm(`Remover "${goal}" de todos os dias?`)) {
    customGoals = customGoals.filter(g => g !== goal);
    save();
    loadChecklist(datePicker.value);
  }
}

function loadChecklist(dateKey) {
  if (!data[dateKey]) data[dateKey] = { checks: {}, points: 0 };
  const date = parseDate(dateKey);
  const weight = (date.getDay() === 0 || date.getDay() === 6) ? 5 : 1;

  document.getElementById("activeDateText").innerText = 
    `${weight === 5 ? 'Fim de Semana (5x Pontos)' : 'Dia de Semana (1x Ponto)'}`;

  const checklistEl = document.getElementById("checklist");
  const extraGoalsEl = document.getElementById("extraGoalsList");

  checklistEl.innerHTML = "";
  ITEMS.forEach(item => checklistEl.appendChild(createItemRow(item, dateKey, weight, true)));

  extraGoalsEl.innerHTML = "";
  customGoals.forEach(goal => extraGoalsEl.appendChild(createItemRow(goal, dateKey, 0, false)));

  updatePoints(dateKey, weight);
}

function createItemRow(text, dateKey, weight, isFixed) {
  const container = document.createElement("div");
  const isChecked = !!data[dateKey].checks[text];
  container.className = `habit-item ${isChecked ? 'checked' : ''}`;
  
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = isChecked;

  const span = document.createElement("span");
  span.className = "habit-text";
  span.innerText = text;

  container.appendChild(cb);
  container.appendChild(span);

  if (!isFixed) {
    const btn = document.createElement("button");
    btn.className = "btn-delete";
    btn.innerText = "Sair";
    btn.onclick = (e) => deleteGoal(e, text);
    container.appendChild(btn);
  }

  container.onclick = (e) => {
    if(e.target.tagName === 'BUTTON') return;
    cb.checked = !cb.checked;
    data[dateKey].checks[text] = cb.checked;
    container.classList.toggle('checked', cb.checked);
    updatePoints(dateKey, weight);
    save();
  };

  return container;
}

function updatePoints(dateKey, weight) {
  const count = ITEMS.filter(item => data[dateKey].checks[item]).length;
  data[dateKey].points = count * (weight || 1);
  document.getElementById("dailyPoints").innerText = `‚≠ê ${data[dateKey].points} Pontos`;
}

function getCycle(date) {
  let start = new Date(date.getFullYear(), date.getMonth(), 12);
  if (date.getDate() < 12) start.setMonth(start.getMonth() - 1);
  let end = new Date(start.getFullYear(), start.getMonth() + 1, 11);
  return { start, end };
}

function updateCycleReport() {
  const select = document.getElementById("cycleSelect");
  const currentVal = select.value;
  select.innerHTML = "";

  const cycles = {};
  const { start: currentStart } = getCycle(new Date());
  cycles[formatKey(currentStart)] = currentStart;

  Object.keys(data).forEach(k => {
    const { start } = getCycle(parseDate(k));
    cycles[formatKey(start)] = start;
  });

  Object.values(cycles).sort((a,b) => b - a).forEach(start => {
    const end = new Date(start.getFullYear(), start.getMonth()+1, 11);
    const opt = document.createElement("option");
    opt.value = formatKey(start);
    opt.text = `Ciclo ${start.toLocaleDateString("pt-BR")}...`;
    select.appendChild(opt);
  });

  select.value = currentVal || select.options[0].value;
  const cycleStart = parseDate(select.value);
  const cycleEnd = new Date(cycleStart.getFullYear(), cycleStart.getMonth()+1, 11);

  let total = 0;
  const list = document.getElementById("cycleDays");
  list.innerHTML = "";

  Object.keys(data).sort().reverse().forEach(k => {
    const d = parseDate(k);
    if (d >= cycleStart && d <= cycleEnd) {
      total += data[k].points || 0;
      const li = document.createElement("li");
      li.innerHTML = `<span>${d.toLocaleDateString("pt-BR")}</span> <strong>${data[k].points} pts</strong>`;
      list.appendChild(li);
    }
  });

  document.getElementById("cycleRange").innerText = `Per√≠odo: 12 ao dia 11`;
  document.getElementById("cyclePoints").innerText = total;
}

datePicker.value = formatKey(new Date());
datePicker.onchange = () => loadChecklist(datePicker.value);
document.getElementById("cycleSelect").onchange = updateCycleReport;
loadChecklist(datePicker.value);
updateCycleReport();
</script>

</body>
</html>